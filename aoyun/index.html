<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>慧眼英雄 火热英伦</title>
<link rel="shortcut icon" href="favicon.ico">
<link rel="icon" type="image/gif" href="animated_favicon1.gif">
<link rel="stylesheet" type="text/css" href="css/css.css" />
<script type="text/javascript" src="js/jquery1.7.1.js"></script>
<script type="text/javascript" src="js/jquery.masonry.min.js"></script>
<script type="text/javascript" src="js/umaclient.js"></script>
<script type="text/javascript" src="js/jquery.form.js"></script>
<script type="text/javascript" src="js/common.js"></script>
<script type="text/javascript">
$(function() {
	var options = {
		target: '#request',			// 把服务器返回的内容放进这个id里面显示出来
		beforeSubmit: showRequest,	// 提交前回调
		success: showResponse,		// 提交后回调
		url: "upload.php"			// 如果重新申明了就会覆盖action这个url
		//type:      type			// 'get' or 'post', 如果申请则会覆盖
		//dataType:  null			// 'xml', 'script', or 'json' (接受服务器返回的类型)
		//clearForm: true			// 成功提交后，清楚所有表单中的值
		//resetForm: true			// 成功提交后，重置所有表单的值
		//timeout:   3000			//限制请求时间，当请求大于3秒的时候跳出请求
	};
	$('#form').ajaxForm(options);
	$(".btn_up").click(function(){
		if($("#uma_upload_image").val() == "") {
			alert("请选择图片上传！");
		}
		else {
			$("#btn_submit").click();
		}
	});
	$("#uma_upload_image").change(function(){
		var name = $("#uma_upload_image").val();
		$(".filename").text(name);
		if(!$(".btn_upload").hasClass("hidden1")) {
			$(".btn_upload").addClass("hidden1");
		}
		$("#uma_upload_image").addClass("hidden");
		$(".btn_up").attr("src","images/btn_up.gif");
	});
}); 
//提交前回调
function showRequest(formData, jqForm, options) {
	var queryString = $.param(formData);
	//alert(queryString);
	$(".btn_up").hide();
	$(".loading").show();
	return true;
} 
//提交后回调
function showResponse(responseText)  {
	//alert(responseText);
	if(responseText.indexOf("Extension") != -1) {
		$(".filename").text("");
		alert("上传失败，超时或非gif，jpg，png格式图片，请重试！");
	}
	else {
		$(".btn_upload").removeClass("hidden1");
		alert("图片上传成功！");
	}
	$(".btn_up").show();
	$(".loading").hide();
	$("#uma_upload_image").removeClass("hidden");
	$("#uma_upload_image").val("");
	$(".btn_up").attr("src","images/btn_up1.gif");
}
</script>
</head>
<body>
<div class="top_wrap">
	<div class="top">
		<img src="images/logo.gif" alt="" class="logo" />
		<img src="images/lundun.gif" alt="伦敦" class="city" />
	</div>
</div>
<div class="wrap">
	<div class="banner">
		<img src="images/banner.jpg" alt="" />
	</div>
	<div class="info">
		<div class="info_l">
			<img src="images/rule_1.gif" width="486" height="150" alt="" class="block" />
			<img src="images/rule_2.gif" width="486" height="150" alt="" class="none" />
			<img src="images/btn_join.gif" width="265" height="116" alt="立刻参加" class="btn_join" />
			<div class="fabiao none">
				<textarea>#添柏岚慧眼英雄 火热英伦＃</textarea>
				<form id="form" name="form" action="" method="post"><!--style="width:0; height:0; overflow:hidden;"-->
					<input type="file" value="上传" id="uma_upload_image" class="uma_upload_image" name="uma_upload_image">
					<input type="submit" value="upload" id="btn_submit" class="none" />
					<img src="images/btn_fabu.gif" width="68" height="28" alt="发布" class="btn_fabu" />
					<img src="images/isupload.gif" width="29" height="25" alt="图片" class="btn_upload hidden1" /><img src="images/loading.gif" alt="" class="loading none" />　<img src="images/btn_up1.gif" width="68" height="28" alt="上传" class="btn_up" /><span class="filename"></span>
				</form>
				<span id="request" class="none"></span>
			</div>
		</div>
		<div class="info_r">
			<img src="images/rukou.jpg" width="286" height="266" alt="" usemap="#map" />
			<map id="map" name="map">
				<area shape="rect" coords="6,98,200,116" href="http://timberland.umaman.com/" target="_blank" title="" alt="" />
			</map>
		</div>
		<div class="jiangpin">
			<div class="jiangpin_title"><img src="images/title_jp.gif" width="78" height="32" alt="活动奖品" /><img src="images/title_jp1.gif" width="222" height="32" alt="" /></div>
			<div class="jiangpin_pic">
				<img src="images/jp1.jpg" alt="" />
				<img src="images/jp2.jpg" alt="" />
				<img src="images/jp3.jpg" alt="" class="img_last" />
			</div>
		</div>
	</div>
	<div class="pics">
		<p class="p_top">活动照片（<span id="pictotal">loading</span>）</p>
		<ul id="container">
			<!--<li class="item">
				<img src="images/01.jpg" alt="" class="img" />
				<span class="picname">伦敦桥</span>
				<div class="btns">
					<img src="images/face.jpg" alt="" class="face" />
					<span class="name">旅行者<br/>旅行者</span>
					<img src="images/btn_zhuanfa.gif" alt="转发" class="btn_zf" /><img src="images/btn_pinlun.gif" alt="评论" class="btn_pl" />
				</div>
			</li>
			<li class="item">
				<img src="images/02.jpg" alt="" class="img" />
				<span class="picname">伦敦桥</span>
				<div class="btns">
					<img src="images/face.jpg" alt="" class="face" />
					<span class="name">旅行者<br/>旅行者</span>
					<img src="images/btn_zhuanfa.gif" alt="转发" class="btn_zf" /><img src="images/btn_pinlun.gif" alt="评论" class="btn_pl" />
				</div>
			</li>
			<li class="item">
				<img src="images/03.jpg" alt="" class="img" />
				<span class="picname">伦敦桥</span>
				<div class="btns">
					<img src="images/face.jpg" alt="" class="face" />
					<span class="name">旅行者<br/>旅行者</span>
					<img src="images/btn_zhuanfa.gif" alt="转发" class="btn_zf" /><img src="images/btn_pinlun.gif" alt="评论" class="btn_pl" />
				</div>
			</li>
			<li class="item">
				<img src="images/04.jpg" alt="" class="img" />
				<a href="javascript:;" onclick="javascript:gotiezi(3478945230111401);"><span class="picname">伦敦桥</span></a>
				<div class="btns">
					<img src="images/face.jpg" alt="" class="face" />
					<span class="name">旅行者<br/>旅行者</span>
					<div class="btn_zf">
						<img src="images/btn_zhuanfa.gif" alt="转发" /><br/>
						<span class="zfnum">0</span>
					</div>
					<div class="btn_pl">
						<img src="images/btn_pinlun.gif" alt="评论" /><br/>
						<span class="plnum">0</span>
					</div>
				</div>
			</li>-->
		</ul>
		<p class="p_bottom">
			<a href="javascript:;" onclick="javascript:loadMore();"></a><img src="images/loading.gif" alt="" class="loading_more none" />
		</p>
	</div>
</div>
<div class="mask"></div>
<div class="bigpic" onclick="javascript:closeTan();">
	<div><img src="" alt="" /></div>
</div>
<div class="fayan">
	<div class="fayan_title">
		<div class="btn_close"></div>转发
	</div>
	<div class="fayan_pic"><img src="images/01.jpg" alt="" /></div>
	<textarea class="textarea">#添柏岚慧眼英雄 火热英伦＃</textarea>
	<img src="images/fayan_btn.gif" alt="转发" class="btn_fayan" />
</div>
<script type="text/javascript">
var loadStart = 0;
var isLoad=false;
var sinatoken = "";
var tokenid = 0;
var tokennum = 0;
umaWeibo.callback = function(data) {
	//console.info(data);
	getwbtoken(data);
}
umaWeibo.getAccessTokenList(50);
function getwbtoken(jsons) {
	tokennum = jsons[tokenid]._id;
	//console.log(tokennum);
	umaWeibo.callback = function(data) {
		//console.info(data);
		if(data.error !== undefined) {
			tokenid++;
			getwbtoken(jsons);
		}
		else {
			sinatoken=tokennum;
			loadMore();
			//console.log(sinatoken);
			return;
		}
	}
	umaWeibo.get(tokennum,'statuses/show',{id:3479469648208428});
}
function loadMore() {
	var total = parseInt($("#pictotal").text());
	if(loadStart >= total) {
		//alert("已经没有其他数据了！");
		$(".p_bottom a").html("已经没有其他数据了！");
		return;
	}
	isLoad=true;
	$(".loading_more").show();
	umaWeibo.callback = function(data) {
		$("#pictotal").text(data.total);
		//console.info(data);
		var html = '';
		$.each(data.result,function(index,value){
			html += '<li class="item" id="'+value.datas.id+'">'+
				'<img src="'+value.datas.pic+'" alt="" class="img" onclick="javascript:showBigpic(\''+value.datas.piclarge+'\');" />'+
				'<a href="javascript:;" onclick="javascript:gotiezi('+value.datas.id+','+value.datas.userid+');"><span class="picname">'+value.datas.content+'</span></a>'+
				'<div class="btns">'+
					'<a href ="http://weibo.com/'+value.datas.userid+'" target="_blank"><img src="'+value.datas.userface+'" alt="" class="face" /></a>'+
					'<a href ="http://weibo.com/'+value.datas.userid+'" target="_blank"><span class="name">'+value.datas.username+'</span></a>'+
					'<div class="btn_zf"><img src="images/btn_zhuanfa.gif" alt="转发" onclick="javaxcript:show_repost_or_comment(\''+value.datas.id+'\',\'repost\',\'0\',\''+value.datas.content+'\',\''+value.datas.pic+'\',\''+value.datas.piclarge+'\');" /><br/><span class="zfnum">0</span></div><div class="btn_pl"><img src="images/btn_pinlun.gif" alt="评论" onclick="javaxcript:show_repost_or_comment(\''+value.datas.id+'\',\'comment\',\'0\',\''+value.datas.content+'\',\''+value.datas.pic+'\',\''+value.datas.piclarge+'\');" /><br/><span class="plnum">0</span></div>';
			html += '</div></li>';
			var postid = value.datas.id;
			//console.log(sinatoken);
			umaWeibo.callback = function(data) {
				//console.info(data);
				setTimeout(function(){
					$("#"+postid).find(".zfnum").text(data.reposts_count);
					$("#"+postid).find(".plnum").text(data.comments_count);
				},5000);
			}
			umaWeibo.get(sinatoken,'statuses/show',{id:value.datas.id});
		});
		loadStart += data.result.length;
		
		var $html = $(html);
		$html.imagesLoaded(function(){
			$("#container").append($html).masonry( 'appended', $html ,true );
			isLoad=false;
			$(".loading_more").hide();
		});
	}
	umaWeibo.getRecord("5018a8f97c999daa7400000c",{},{},loadStart,4);
}

$(function(){
	$("#container").imagesLoaded(function(){
		$("#container").masonry({
			itemSelector:".item",
			columnWidth:237
		});
	});
	
	$(window).scroll(function(){
		if($(document).scrollTop() + $(window).height() >= $(document).height()-150&&!isLoad) {
			if(loadStart>0) loadMore();
		}
	});
	
	//loadMore();
});
</script>
</body>
</html>
